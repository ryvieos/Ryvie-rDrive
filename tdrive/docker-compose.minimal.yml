version: "3.4"

services:
  mongo:
    container_name: app-rdrive-mongo
    image: mongo
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 2m
      retries: 30
      start_period: 10s
    volumes:
      - ./docker-data/mongo:/data/db
    ports:
      - 27017:27017
    networks:
      - tdrive_default
      - ldap_my_custom_network

  node_create_user:
    container_name: app-rdrive-node-create-user
    build: &backend_docker_build
      context: .
      dockerfile: docker/tdrive-node/Dockerfile
      target: production
    environment: &backend_env_vars
      - DEV=dev
      - ACCOUNTS_TYPE=internal
      - DB_DRIVER=mongodb
      - DB_MONGO_URI=mongodb://mongo:27017
      - PUBSUB_TYPE=local
      - SEARCH_DRIVER=mongodb
      - STORAGE_DRIVER=local
      - STORAGE_LOCAL_PATH=/tdrive
      - ENABLE_FEATURE_ANTIVIRUS=false
      - DIAG_PROBE_SECRET=diag-secret
      - LDAP_URL=ldap://openldap:1389
      - LDAP_BIND_DN=cn=admin,dc=example,dc=org
      - LDAP_BIND_PASSWORD=adminpassword
      - LDAP_BASE_DN=dc=example,dc=org
      - LDAP_USERS_DN=ou=users,dc=example,dc=org
      - LDAP_GROUPS_DN=ou=groups,dc=example,dc=org
    command: node dist/bin/sync_ldap_users.js
    volumes: &backend_volumes
      - ./backend/node/profiles:/usr/src/app/profiles
      - ./backend/node/src:/usr/src/app/src
      - ./docker-data/files:/tdrive/docker-data/files
      - /usr/bin/rclone:/usr/bin/rclone:ro
      - /root/.config/rclone:/root/.config/rclone
    depends_on: &backend_dependencies
      mongo:
        condition: service_healthy
    networks:
      - tdrive_default
      - ldap_my_custom_network

  node:
    container_name: app-rdrive-node
    build: *backend_docker_build
    ports:
      - 4000:4000
      - 9229:9229
    environment: *backend_env_vars
    healthcheck:
      test: curl --fail 'http://localhost:4000/diagnostics/t/ready?secret=diag-secret'
    volumes: *backend_volumes
    depends_on:
      <<: *backend_dependencies
      node_create_user:
        condition: service_completed_successfully
    networks:
      - tdrive_default
      - ldap_my_custom_network

  frontend:
    build:
      context: .
      dockerfile: docker/tdrive-frontend/Dockerfile
      args:
        REACT_APP_FRONTEND_URL: "https://rdrive.demo.ryvie.fr"
        REACT_APP_BACKEND_URL: "https://backend.rdrive.demo.ryvie.fr"
        REACT_APP_WEBSOCKET_URL: "wss://backend.rdrive.demo.ryvie.fr/ws"
        REACT_APP_ONLYOFFICE_CONNECTOR_URL: "https://connector.rdrive.demo.ryvie.fr"
        REACT_APP_ONLYOFFICE_DOCUMENT_SERVER_URL: "https://document.rdrive.demo.ryvie.fr"
    container_name: app-rdrive-frontend
    environment:
      - DEV=production
      - SSL_CERTS=off
      - NODE_HOST=http://node:4000
    ports:
      - 3010:80
      - 8443:443
    depends_on:
      node:
        condition: service_healthy
    volumes:
      - ./docker-data/logs/nginx/:/var/log/nginx
      - ./docker-data/letsencrypt/:/etc/letsencrypt/
      - ./docker-data/drive-preview/:/tdrive-core/web/medias/
      - ./docker-data/uploads/:/tdrive-core/web/upload/
      - ./docker-data/ssl:/etc/nginx/ssl
    networks:
      - tdrive_default
      - ldap_my_custom_network

networks:
  tdrive_default:
    name: tdrive_default
  ldap_my_custom_network:
    external: true
